use core:net;
use core:io;
use http;
use core:lang;

void main(){
  //Listener? socket = listen(1234, true);
  //unless(socket){
   // print("Error! Cannot bind socket.");
   // return;
  //}
  HTTP_Server server(1234);


  while(true){
    HTTP_Request req;
    try {
        req = server.recieve();
    } catch (SyntaxError e) {
        HTTP_Response resp;
        resp.version = HTTP_Version:HTTP_1_1;
        resp.status_code = HTTP_StatusCode:Bad_Request;
        resp.headers.put("content-type", "text/html; charset=utf-8");
        resp.headers.put("content-length", "15");
        resp.headers.put("connection", "close");
        resp.data = "400 Bad Request".toUtf8;
        server.send(resp);
        continue;
    }
    //Read requests here...
    print("\n\nRecieved the following request:");
    print("Method: ${req.method}");
    print("HTTP Version: ${req.version}");
    print("Path: ${req.path.toS()}");
    print("\nMethod parameters:");
    for(k, v in req.method_params){
      print("${k} : ${v}");
    }
    HTTP_Response res;
    //TODO skapa header tests Fille o/c.
    res.version = HTTP_Version:HTTP_1_1;
    res.status_code = HTTP_StatusCode:OK;
    
    //res.headers.types.push(HTTP_Header_Type:Content_Length);
    // res.headers.contents.push("132");

    res.headers.put("content-type", "text/html; charset=utf-8");
    //res.headers.contents.push("text/html; charset=utf-8");

    //TODO, check if this impelemntation works:
    res.headers.put("connection", "close");
    Url index_page = cwdUrl;                       
    index_page = index_page / "index.html";
    print("\nSending response...");
    res.data = toUtf8(index_page.readAllText.toS());

    
    //res.headers.contents.push("close");

    server.send(res);
  }
}
